<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HR Candidate Submission</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
  .container { width: 100%; min-height: 100vh; padding: 40px; background: linear-gradient(to right, #f7f5f4, #eef0f5); }
  .form-wrapper { background: white; border-radius: 16px; padding: 35px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); max-width: 1300px; margin: 0 auto; }
  h2 { text-align: center; background: #6a86dc; color: white; padding: 15px; border-radius: 10px; margin: 0 0 20px 0; font-size: 1.5rem; }
  .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 0.9rem; }
  .import-section { background: #e8f4f8; border: 2px dashed #4a90e2; border-radius: 12px; padding: 25px; margin-bottom: 25px; text-align: center; }
  .import-section h3 { margin-top: 0; color: #2c5aa0; }
  .import-btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
  .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
  .btn-green { background: #28a745; color: white; }
  .btn-blue { background: #4a90e2; color: white; }
  .btn:hover { transform: translateY(-2px); }
  #fileInput { display: none; }
  .candidate-section { border: 2px solid #ccc; border-radius: 12px; padding: 25px; margin-top: 25px; background: #fafafa; position: relative; }
  .candidate-section h3 { margin-top: 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
  .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
  .form-group { flex: 1; min-width: 250px; }
  label { display: block; font-weight: bold; margin-top: 10px; }
  input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; }
  .upload-box { border: 2px dashed #aaa; padding: 15px; text-align: center; background: #fff; border-radius: 8px; margin-top: 5px; }
  .resume-info { margin-top: 10px; font-size: 0.85rem; color: #666; }
  .delete-btn { position: absolute; right: 15px; top: 15px; background: #ff4d4d; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-weight: bold; }
  .add-btn { margin-top: 25px; background: #4a90e2; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
  .submit-btn { margin-top: 25px; background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
  .success, .error { padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; }
  .success { background: #d4edda; color: #155724; }
  .error { background: #f8d7da; color: #721c24; }
  .hidden { display: none; }
  .loader { display: none; text-align: center; margin-top: 20px; }
  .loader.active { display: block; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @media (max-width: 768px) { .form-row { flex-direction: column; } }
</style>
</head>
<body>
  <div class="container">
    <div class="form-wrapper">
      <h2>HR Candidate Submission</h2>
      
      <div class="info-box">
        <strong>üìã How to Submit:</strong><br>
        1Ô∏è‚É£ Fill agency details and add candidates (or import CSV)<br>
        2Ô∏è‚É£ Upload resume for each candidate<br>
        3Ô∏è‚É£ Click "Submit All Candidates" - data will be sent to n8n<br>
        <em style="color: #0c5bb4;">‚úÖ CSV import works! All data including resumes will be submitted.</em>
      </div>

        <div class="import-section">
          <h3>üìä CSV Import</h3>
          <div class="import-btn-group">
            <button type="button" class="btn btn-green" onclick="downloadCSV()">üì• Download Template</button>
            <button type="button" class="btn btn-blue" onclick="document.getElementById('fileInput').click()">üì§ Import CSV</button>
            <input type="file" id="fileInput" accept=".csv" onchange="importCSV(event)">
          </div>
          <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">CSV import will populate candidate details. You'll still need to upload resumes manually.</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>HR Name *</label>
            <input type="text" id="HRName" required>
          </div>
          <div class="form-group">
            <label>HR Email *</label>
            <input type="email" id="HREmail" required>
          </div>
        </div>

        <div id="candidateContainer">
          <div class="candidate-section">
            <button type="button" class="delete-btn" onclick="deleteCand(this)">Delete</button>
            <h3>Candidate 1</h3>
            <div class="form-row">
              <div class="form-group"><label>Name *</label><input type="text" class="cand-name" required></div>
              <div class="form-group"><label>Email *</label><input type="email" class="cand-email" required></div>
              <div class="form-group"><label>Organization</label><input type="text" class="cand-org"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Experience (Yrs)</label><input type="number" class="cand-exp"></div>
              <div class="form-group"><label>Notice (Days)</label><input type="text" class="cand-notice"></div>
              <div class="form-group"><label>Current Location</label><input type="text" class="cand-loc"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label>Preferred Location</label><input type="text" class="cand-pref"></div>
              <div class="form-group"><label>Current CTC</label><input type="text" class="cand-ctc"></div>
              <div class="form-group"><label>Expected CTC</label><input type="text" class="cand-ectc"></div>
            </div>
            <div class="form-group"><label>LinkedIn</label><input type="url" class="cand-li"></div>
            <div class="form-group"><label>Remarks</label><textarea class="cand-rem" rows="3"></textarea></div>
            <div class="form-group">
              <label>Resume (PDF/DOC/DOCX) *</label>
              <div class="upload-box">
                <input type="file" class="cand-resume" accept=".pdf,.doc,.docx" required onchange="handleResumeUpload(this)">
                <div class="resume-info"></div>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="add-btn" onclick="addCand()">+ Add Candidate</button>
        <button type="button" class="submit-btn" onclick="submitForm()">‚úÖ Submit All Candidates</button>

        <div class="loader" id="loader">
          <div class="spinner"></div>
          <p>Processing resumes and submitting...</p>
        </div>

        <div id="msg"></div>
      </div>
    </div>
  </div>

<script>
// Configuration - UPDATE THIS WITH YOUR N8N WEBHOOK URL
;const N8N_WEBHOOK_URL = "https://n8n.wowflo.io/webhook/hr_response";
function downloadCSV() {
  const csv = "Candidate Name*,Candidate Email*,Current Organization,Experience (Years),Notice Period (Days),Current Location,Preferred Location,Current CTC (LPA),Expected CTC (LPA),LinkedIn Profile,Remarks\n" +
    "Rajesh Kumar,rajesh@email.com,Infosys,5,60,Bangalore,Hyderabad,8,12,https://linkedin.com/in/rajesh,Java developer\n" +
    "Priya Sharma,priya@email.com,TCS,3,30,Mumbai,Pune,6,9,https://linkedin.com/in/priya,Full-stack developer";
  const blob = new Blob([csv], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'candidates_template.csv';
  a.click();
  msg('‚úÖ CSV template downloaded!', 1);
}
const urlParamss = new URLSearchParams(window.location.search);
const EXECUTION_ID = urlParamss.get('execution_id') || 'UNKNOWN';
console.log('Execution ID:', EXECUTION_ID);


function importCSV(e) {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = (ev) => {
    const rows = parseCSV(ev.target.result);
    if (rows.length < 2) return msg('‚ùå No data found in CSV!', 0);
    const h = rows[0], data = rows.slice(1).map(row => {
      const o = {};
      h.forEach((k, i) => o[k] = row[i] || '');
      return o;
    });
    
    // Clear existing candidates first
    const container = document.getElementById('candidateContainer');
    container.innerHTML = '';
    
    // Populate with CSV data
    populateCands(data);
    
    msg(`‚úÖ Imported ${data.length} candidates! Remember to upload resumes.`, 1);
  };
  r.readAsText(file);
  e.target.value = '';
}

function parseCSV(txt) {
  const rows = [];
  let row = [], field = '', inQ = false;
  for (let i = 0; i < txt.length; i++) {
    const c = txt[i], n = txt[i+1];
    if (c === '"') {
      if (inQ && n === '"') { field += '"'; i++; }
      else inQ = !inQ;
    } else if (c === ',' && !inQ) {
      row.push(field.trim());
      field = '';
    } else if ((c === '\n' || c === '\r') && !inQ) {
      if (field || row.length) {
        row.push(field.trim());
        rows.push([...row]);
        row = [];
        field = '';
      }
      if (c === '\r' && n === '\n') i++;
    } else field += c;
  }
  if (field || row.length) {
    row.push(field.trim());
    rows.push(row);
  }
  return rows.filter(r => r.some(c => c));
}

function populateCands(data) {
  const c = document.getElementById('candidateContainer');
  c.innerHTML = '';
  data.forEach((d, i) => {
    const s = document.createElement('div');
    s.className = 'candidate-section';
    s.innerHTML = `<button type="button" class="delete-btn" onclick="deleteCand(this)">Delete</button><h3>Candidate ${i+1}</h3>
      <div class="form-row">
        <div class="form-group"><label>Name *</label><input type="text" class="cand-name" value="${d['Candidate Name*']||''}" required></div>
        <div class="form-group"><label>Email *</label><input type="email" class="cand-email" value="${d['Candidate Email*']||''}" required></div>
        <div class="form-group"><label>Organization</label><input type="text" class="cand-org" value="${d['Current Organization']||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Experience</label><input type="number" class="cand-exp" value="${d['Experience (Years)']||''}"></div>
        <div class="form-group"><label>Notice</label><input type="text" class="cand-notice" value="${d['Notice Period (Days)']||''}"></div>
        <div class="form-group"><label>Location</label><input type="text" class="cand-loc" value="${d['Current Location']||''}"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Preferred</label><input type="text" class="cand-pref" value="${d['Preferred Location']||''}"></div>
        <div class="form-group"><label>CTC</label><input type="text" class="cand-ctc" value="${d['Current CTC (LPA)']||''}"></div>
        <div class="form-group"><label>Expected</label><input type="text" class="cand-ectc" value="${d['Expected CTC (LPA)']||''}"></div>
      </div>
      <div class="form-group"><label>LinkedIn</label><input type="url" class="cand-li" value="${d['LinkedIn Profile']||''}"></div>
      <div class="form-group"><label>Remarks</label><textarea class="cand-rem" rows="3">${d['Remarks']||''}</textarea></div>
      <div class="form-group">
        <label>Resume (PDF/DOC/DOCX) *</label>
        <div class="upload-box">
          <input type="file" class="cand-resume" accept=".pdf,.doc,.docx" required onchange="handleResumeUpload(this)">
          <div class="resume-info"></div>
        </div>
      </div>`;
    c.appendChild(s);
  });
}

function addCand() {
  const c = document.getElementById('candidateContainer');
  const n = c.querySelectorAll('.candidate-section').length + 1;
  const clone = c.querySelector('.candidate-section').cloneNode(true);
  clone.querySelector('h3').textContent = `Candidate ${n}`;
  clone.querySelectorAll('input:not([type="file"]),textarea').forEach(el => el.value = '');
  
  // Reset file input
  const fileInput = clone.querySelector('.cand-resume');
  fileInput.value = '';
  fileInput.removeAttribute('data-base64');
  clone.querySelector('.resume-info').innerHTML = '';
  
  c.appendChild(clone);
}

function deleteCand(btn) {
  if (document.querySelectorAll('.candidate-section').length <= 1) return alert('Need at least 1 candidate!');
  btn.closest('.candidate-section').remove();
  document.querySelectorAll('.candidate-section').forEach((s, i) => s.querySelector('h3').textContent = `Candidate ${i+1}`);
}

function handleResumeUpload(input) {
  const file = input.files[0];
  const infoDiv = input.parentElement.querySelector('.resume-info');
  
  if (!file) {
    infoDiv.innerHTML = '';
    return;
  }
  
  infoDiv.innerHTML = '‚è≥ Processing...';
  infoDiv.style.color = '#666';
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64Data = e.target.result;
    input.setAttribute('data-base64', base64Data);
    input.setAttribute('data-filename', file.name);
    input.setAttribute('data-filetype', file.type);
    input.setAttribute('data-filesize', file.size);
    infoDiv.innerHTML = `‚úÖ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    infoDiv.style.color = '#28a745';
  };
  
  reader.onerror = function() {
    infoDiv.innerHTML = '‚ùå Error reading file';
    infoDiv.style.color = '#dc3545';
  };
  
  reader.readAsDataURL(file);
}

async function submitForm() {
  const HRName = document.getElementById('HRName').value;
  const HREmail = document.getElementById('HREmail').value;
  
  if (! HRName || !HREmail) {
    return msg('‚ùå Please fill in agency details!', 0);
  }
  
  const loader = document.getElementById('loader');
  loader.classList.add('active');
  
  await new Promise(resolve => setTimeout(resolve, 100));
  
  const cands = [];
  const sections = document.querySelectorAll('.candidate-section');
  
  for (let i = 0; i < sections.length; i++) {
    const s = sections[i];
    const name = s.querySelector('.cand-name').value;
    const email = s.querySelector('.cand-email').value;
    const resumeInput = s.querySelector('.cand-resume');
    
    if (!name || !email) {
      loader.classList.remove('active');
      return msg('‚ùå All candidates must have name and email!', 0);
    }
    
    if (!resumeInput.files[0]) {
      loader.classList.remove('active');
      return msg(`‚ùå Please upload resume for ${name}!`, 0);
    }
    
    const base64Data = resumeInput.getAttribute('data-base64');
    if (!base64Data) {
      loader.classList.remove('active');
      return msg(`‚ùå Resume for ${name} is still processing. Please wait.`, 0);
    }
    
    cands.push({
      candidate_name: name,
      candidate_email: email,
      current_organization: s.querySelector('.cand-org').value,
      experience: s.querySelector('.cand-exp').value,
      notice_period: s.querySelector('.cand-notice').value,
      current_location: s.querySelector('.cand-loc').value,
      preferred_location: s.querySelector('.cand-pref').value,
      current_ctc: s.querySelector('.cand-ctc').value,
      expected_ctc: s.querySelector('.cand-ectc').value,
      linkedin: s.querySelector('.cand-li').value,
      remarks: s.querySelector('.cand-rem').value,
      resume: {
        name: resumeInput.getAttribute('data-filename'),
        type: resumeInput.getAttribute('data-filetype'),
        size: parseInt(resumeInput.getAttribute('data-filesize')),
        data: base64Data
      }
    });
  }
  
  const payload = {
    execution_id: EXECUTION_ID,
    agency_name: HRName,
    agency_email: HREmail,
    candidateContainer: cands,
    submitted_at: new Date().toISOString()
  };
  
  const jsonStr = JSON.stringify(payload);
  const totalSizeKB = (jsonStr.length / 1024).toFixed(1);
  
  console.log('üì§ Submitting payload:', payload);
  console.log('üìä Total size:', totalSizeKB, 'KB');
  
  try {
    // Send directly to n8n webhook
    const response = await fetch(N8N_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: jsonStr
    });
    
    console.log('üì• Response status:', response.status);
    
    loader.classList.remove('active');
    
    if (response.ok) {
      msg(`‚úÖ Successfully submitted ${cands.length} candidate(s) with resumes! (${totalSizeKB} KB)`, 1);
      
      // Reset form after successful submission
      setTimeout(() => {
        if (confirm('Submission successful! Reset form for new submission?')) {
          location.reload();
        }
      }, 2000);
    } else {
      const errorText = await response.text();
      console.error('‚ùå Error response:', errorText);
      msg(`‚ùå Submission failed: ${response.statusText}`, 0);
    }
  } catch (error) {
    console.error('‚ùå Submission error:', error);
    loader.classList.remove('active');
    msg(`‚ùå Error: ${error.message}`, 0);
  }
}

function msg(txt, ok) {
  const msgDiv = document.getElementById('msg');
  msgDiv.innerHTML = `<div class="${ok?'success':'error'}">${txt}</div>`;
  msgDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  setTimeout(() => msgDiv.innerHTML = '', 8000);
}
</script>
</body>
</html>